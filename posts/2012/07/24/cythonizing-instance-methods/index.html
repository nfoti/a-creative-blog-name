<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Cythonizing instance methods</title>
  <meta name="author" content="Nick Foti">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="http://github.io/nfoti/a-creative-blog-name/favicon.png" rel="icon">
  <link href="http://github.io/nfoti/a-creative-blog-name/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="http://github.io/nfoti/a-creative-blog-name/theme/js/modernizr-2.0.js"></script>
  <script src="http://github.io/nfoti/a-creative-blog-name/theme/js/ender.js"></script>
  <script src="http://github.io/nfoti/a-creative-blog-name/theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://github.io/nfoti/a-creative-blog-name/">(A Creative Blog Name Here)</a></h1>
    <h2>Code, math, and other things I find useful</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<form action="//google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:github.io/nfoti/a-creative-blog-name" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li><a href="http://github.io/nfoti/a-creative-blog-name/archives.html">Archives</a></li>
    <li><a href="http://github.io/nfoti/a-creative-blog-name/tags.html">Tags</a></li>
    <li><a href="http://nfoti.github.io">Home Page</a></li>
    <li >
    <a href="http://github.io/nfoti/a-creative-blog-name/category/julia.html">Julia</a>
    </li>
    <li >
    <a href="http://github.io/nfoti/a-creative-blog-name/category/octopress.html">Octopress</a>
    </li>
    <li class="active">
    <a href="http://github.io/nfoti/a-creative-blog-name/category/python.html">Python</a>
    </li>
    <li >
    <a href="http://github.io/nfoti/a-creative-blog-name/category/vim.html">Vim</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Cythonizing instance methods</h1>
      <p class="meta"><time datetime="2012-07-24T20:45:00" pubdate>24 July 2012 08-45 PM</time></p>
</header>

  <div class="entry-content"><p>A large amount of my work involves writing MCMC samplers.  The models I work
with have a lot of parameters and the samplers require a lot of state to be
recorded.  Normally, I stuff all of the parameters and state into a Python
class and implement the different steps of the sampler as instance methods.
One advantage of this approach is that the methods that perform the sampling
don't require many arguments.
Some of these methods run slowly due to for-loops that cannot be vectorized.
<a href="http://www.cython.org">Cython</a> seems like a viable way to improve 
performance of these methods.</p>
<p>The simplest way to implement the sampling functions with Cython would be to 
define stand-alone functions in a .pyx file and pass all required data to 
the functions (the functions could then be added to the class if desired).
This defeats the purpose of using a class to store the state of the sampler 
though as we would need to deal with unwieldly function prototypes.  It would
be better to implement the instance method in a .pyx file (i.e. the first
argument to the function is a sampler object) and then add the instance 
method to the class.</p>
<p>In this post I describe how to do this for a contrived class
and record some helpful references for working with Cython.
This is nothing new, it is described on the 
<a href="http://wiki.cython.org/FAQ/#HowdoIimplementasingleclassmethodinaCythonmodule.3F">Cython Wiki</a>
as well as
<a href="http://bfroehle.com/2012/01/instance-methods-and-cython-functions/#more-121">here</a>
.  I have adapted my example from these sources.  Additionally, I provide an
example of calling a function from the Gnu Scientific Library (<a href="http://www.gnu.org/software/gsl/">GSL</a>)
from Cython code.</p>
<!-- more -->

<p 3173622="3173622" _="%" basic.py="basic.py" gist="gist">Let's define a (not very creative) simple class as in the following code</p>
<p 3173622="3173622" _="%" cy1fun.pyx="cy1fun.pyx" gist="gist">Suppose that (after profiling) we have determined that the (also uncreative) 
instance method <code>fun</code> is very inefficient and that we want to implement it 
with cython.  A first attempt at this is </p>
<p>To incorporate the Cython implementation of <code>fun</code> into <code>MyClass</code> we would like
to be able to do</p>
<div class="highlight"><pre><span class="n">MyClass</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">cy1fun</span><span class="o">.</span><span class="n">fun</span>
</pre></div>


<p 3173622="3173622" _="%" cy1.py="cy1.py" gist="gist"><strong>This does not work as all Cython functions are unbound</strong> (see 
<a href="http://wiki.cython.org/FAQ/#HowdoIimplementasingleclassmethodinaCythonmodule.3F">this</a>).
The solution is to use the <code>MethodType</code> method of the <code>types</code> module shown 
here</p>
<p><a href="https://gist.github.com/3173622">This gist</a> contains all of the code that is
used in this post.  The <code>setup.py</code> file that was used to build the code can be 
found there as well.  This is all we have to do to implement instance methods 
in Cython.</p>
<p 3173622="3173622" _="%" cy2.py="cy2.py" gist="gist">One dissatisfactory aspect of <code>cy1fun.pyx</code> is that we are just calling the 
Python function <code>scipy.special.gammaln</code>.  In <code>cy2fun.pyx</code> shown below I 
instead call the <a href="http://www.gnu.org/software/gsl/manual/html_node/Gamma-Functions.html">GSL function</a> 
that computes the natural logarithm of the gamma function (based off of
<a href="http://dpinte.wordpress.com/2010/04/22/interfacing-gsl-with-python-using-cython-comparison-with-weave/">this</a>).
I could have done the same with <code>np.random.rand</code> and used a GSL random number 
function, but I think the point has been made (see
<a href="https://gist.github.com/757090">this</a> for how to use GSL random numbers in
Cython code). 
{% gist 3173622 cy2fun.pyx %}
and the corresponding Python code</p></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Nick Foti</span>
  </span>
<time datetime="2012-07-24T20:45:00" pubdate>24 July 2012 08-45 PM</time>  <span class="categories">
    <a class="category" href="http://github.io/nfoti/a-creative-blog-name/tag/cython.html">cython</a>
    <a class="category" href="http://github.io/nfoti/a-creative-blog-name/tag/instance-methods.html">instance methods</a>
  </span>
</p><div class="sharing">
</div>    </footer>
  </article>

</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://github.io/nfoti/a-creative-blog-name/posts/2013/08/19/calling-rmath-from-cython/">Calling Rmath from cython (sometimes R just does it better)</a>
      </li>
      <li class="post">
          <a href="http://github.io/nfoti/a-creative-blog-name/posts/2013/06/27/types-as-function-arguments-in-julia/">Types as function arguments in Julia</a>
      </li>
      <li class="post">
          <a href="http://github.io/nfoti/a-creative-blog-name/posts/2013/02/07/cleaning-cython-build-files/">Cleaning Cython Build Files</a>
      </li>
      <li class="post">
          <a href="http://github.io/nfoti/a-creative-blog-name/posts/2012/12/14/matplotlib-3d-plots-in-ipython/">Matplotlib 3D plots in IPython</a>
      </li>
      <li class="post">
          <a href="http://github.io/nfoti/a-creative-blog-name/posts/2012/12/13/embedded-gist-appearance/">Embedded gist appearance</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://github.io/nfoti/a-creative-blog-name/category/julia.html">Julia</a></li>
        <li><a href="http://github.io/nfoti/a-creative-blog-name/category/octopress.html">Octopress</a></li>
        <li><a href="http://github.io/nfoti/a-creative-blog-name/category/python.html">Python</a></li>
        <li><a href="http://github.io/nfoti/a-creative-blog-name/category/vim.html">Vim</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="http://github.io/nfoti/a-creative-blog-name/tag/.html"></a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/cython.html">cython</a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/osx.html">osx</a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/rmath.html">Rmath</a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/syntastic.html">syntastic</a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/matplotlib.html">matplotlib</a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/vim.html">vim</a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/types-as-tags.html">types as tags</a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/ipython.html">ipython</a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/virtualenv.html">virtualenv</a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/instance-methods.html">instance methods</a>,    <a href="http://github.io/nfoti/a-creative-blog-name/tag/gsl.html">gsl</a>  </section>


    <section>
        <h1>Social</h1>
        <ul>
            <li><a href="http://github.com/nfoti" target="_blank">github</a></li>
        </ul>
    </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2012-2013  - Nick Foti -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
</body>
</html>